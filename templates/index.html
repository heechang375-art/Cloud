<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>NHN Cloud Infra Deployer</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { background-color: #f4f7f6; padding: 40px; font-family: 'Malgun Gothic', sans-serif; }
        .container { max-width: 1000px; background: white; padding: 40px; border-radius: 15px; box-shadow: 0 10px 30px rgba(0,0,0,0.1); }
        .section-title { font-weight: bold; border-left: 5px solid #0d6efd; padding-left: 12px; margin: 25px 0 15px; color: #333; }
        .log-window { background: #1a1a1a; color: #00ff00; padding: 15px; border-radius: 8px; height: 200px; overflow-y: auto; font-family: monospace; font-size: 0.9rem; border: 1px solid #333; }
        #loading_overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); z-index: 9999; flex-direction: column; justify-content: center; align-items: center; color: white; }
        .final-display { background: #f8f9fa; border: 2px solid #0d6efd; border-radius: 10px; padding: 20px; text-align: center; }
        .readonly-input { background-color: #e9ecef !important; color: #6c757d; cursor: not-allowed; }
    </style>
</head>
<body>

<!-- VPC ì¤‘ë³µ ì„ íƒ ëª¨ë‹¬ -->
<div id="vpc_duplicate_modal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.7); z-index:10000; justify-content:center; align-items:center;">
    <div style="background:white; padding:30px; border-radius:15px; max-width:500px; text-align:center; box-shadow:0 10px 50px rgba(0,0,0,0.3);">
        <h4 class="text-warning">âš ï¸ VPC ì´ë¦„ ì¤‘ë³µ</h4>
        <p class="mt-3">ê°™ì€ ì´ë¦„ì˜ VPCê°€ ì´ë¯¸ ì¡´ì¬í•©ë‹ˆë‹¤:<br><strong id="duplicate_vpc_name"></strong></p>
        <div class="d-grid gap-2 mt-4">
            <button class="btn btn-success btn-lg" onclick="handleVpcDuplicate('use_existing')">
                âœ… ê¸°ì¡´ VPC ì‚¬ìš©í•˜ê¸°
            </button>
            <button class="btn btn-primary btn-lg" onclick="handleVpcDuplicate('create_new')">
                â• íƒ€ì„ìŠ¤íƒ¬í”„ ì¶”ê°€í•´ì„œ ìƒˆë¡œ ë§Œë“¤ê¸°
            </button>
            <button class="btn btn-secondary" onclick="handleVpcDuplicate('cancel')">
                âŒ ì·¨ì†Œ
            </button>
        </div>
    </div>
</div>

<div id="loading_overlay">
    <div class="spinner-border text-primary" style="width: 3rem; height: 3rem;"></div>
    <h3 id="loading_text" class="mt-4">ì¸í”„ë¼ ë¶„ì„ ë° ë°°í¬ ì¤‘...</h3>
    <div class="log-window mt-3" id="log_viewer" style="width: 80%; max-width: 700px;"></div>
</div>

<div class="container">
    <h2 class="text-center mb-5 fw-bold text-primary">NHN Cloud Infra Auto-Deploy</h2>

    <div class="card p-4 mb-4 border-0 shadow-sm bg-light">
        <div class="section-title">1. ê³„ì • ì¸ì¦ ë° ë¦¬ì „</div>
        <form id="auth-form" class="row g-3">
            <div class="col-md-6">
                <label class="form-label fw-bold">ì„œë¹„ìŠ¤ ë¦¬ì „</label>
                <select class="form-select" id="region">
                    <option value="KR1">í•œêµ­(íŒêµ) - KR1</option>
                    <option value="KR2">í•œêµ­(í‰ì´Œ) - KR2</option>
                    <option value="JP1">ì¼ë³¸(ë„ì¿„) - JP1</option>
                    <option value="US1">ë¯¸êµ­(ìº˜ë¦¬í¬ë‹ˆì•„) - US1</option>
                </select>
            </div>
            <div class="col-md-6"><label class="form-label fw-bold">Tenant ID</label><input type="text" id="tenant_id" class="form-control" placeholder="ì½˜ì†”ì—ì„œ í™•ì¸"></div>
            <div class="col-md-6"><label class="form-label fw-bold">ID (Email)</label><input type="email" id="user_id" class="form-control"></div>
            <div class="col-md-6"><label class="form-label fw-bold">API Password</label><input type="password" id="password" class="form-control"></div>
            <div class="col-12 text-end"><button type="button" class="btn btn-primary px-5" onclick="getResources()">ìì› ë™ê¸°í™”</button></div>
        </form>
    </div>

    <div id="deploy-section" style="display:none;">
        <form id="deploy-form">
            <input type="hidden" name="pub_id" id="hidden_pub_id">
            <input type="hidden" name="subnet_cidr" id="hidden_subnet_cidr">
            <input type="hidden" name="vpc_cidr" id="hidden_vpc_cidr">

            <div class="card p-4 mb-4 border-1">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <div class="section-title">2. ì¸í”„ë¼ ìƒì„¸ êµ¬ì„±</div>
                    <div class="btn-group">
                        <input type="radio" class="btn-check" name="mode" id="m_auto" value="m_auto" checked onchange="updateUI()">
                        <label class="btn btn-outline-success" for="m_auto">ê¸°ì¡´ VPC</label>
                        <input type="radio" class="btn-check" name="mode" id="m_new" value="m_new" onchange="updateUI()">
                        <label class="btn btn-outline-primary" for="m_new">ì‹ ê·œ VPC</label>
                    </div>
                </div>

                <div id="vpc_select_area" class="mb-4">
                    <label class="fw-bold">ê¸°ì¡´ VPC ì„ íƒ 
                        <button type="button" class="btn btn-sm btn-outline-primary ms-2" onclick="refreshVpcs()" title="VPC ëª©ë¡ ìƒˆë¡œê³ ì¹¨">
                            ğŸ”„
                        </button>
                    </label>
                    <select id="v_sel" name="selected_vpc_id" class="form-select" onchange="calculateNetwork()"></select>
                </div>
                <div id="vpc_input_area" class="mb-4" style="display:none;">
                    <label class="fw-bold">ì‹ ê·œ VPC CIDR</label>
                    <input type="text" id="custom_vpc_cidr" class="form-control" value="10.0.0.0/16" onkeyup="calculateNetwork()">
                    <small class="text-muted">
                        ê¶Œì¥ ë²”ìœ„: 10.0.0.0/8, 172.16.0.0/12, 192.168.0.0/16 (Private IP ëŒ€ì—­)<br>
                        Prefix: /16 ~ /28 ì‚¬ìš© ê°€ëŠ¥
                    </small>
                </div>

                <div class="row g-3 mb-4">
                    <div class="col-md-4">
                        <label class="fw-bold">3rd Octet (ì…ë ¥)</label>
                        <input type="number" id="third_octet" class="form-control" value="0" min="0" max="255" oninput="calculateNetwork()">
                    </div>
                    <div class="col-md-4">
                        <label class="fw-bold text-primary">Prefix Mask</label>
                        <select id="mask_select" class="form-select" onchange="updateFourthOctetOptions()">
                            <option value="24">/24 (ê°€ìš© 251ê°œ)</option>
                            <option value="25">/25 (ê°€ìš© 123ê°œ)</option>
                            <option value="26">/26 (ê°€ìš© 59ê°œ)</option>
                            <option value="27">/27 (ê°€ìš© 27ê°œ)</option>
                            <option value="28">/28 (ê°€ìš© 11ê°œ)</option>
                        </select>
                    </div>
                    <div class="col-md-4">
                        <label class="fw-bold text-danger">4th Octet (ì‹œì‘ ì£¼ì†Œ)</label>
                        <select id="fourth_octet_select" class="form-select" onchange="calculateNetwork()"></select>
                    </div>
                </div>

                <div class="final-display mb-4">
                    <div class="small text-muted">ìµœì¢… ë°°í¬ CIDR ëŒ€ì—­</div>
                    <b id="display_cidr" class="fs-2 text-primary">10.0.0.0/24</b>
                    <div class="small text-muted mt-2">
                        âœ“ Subnetì€ ë°˜ë“œì‹œ VPC CIDR ë²”ìœ„ ë‚´ì— ìˆì–´ì•¼ í•©ë‹ˆë‹¤<br>
                        âœ“ ì˜ˆ: VPCê°€ 10.0.0.0/16ì´ë©´ â†’ Subnetì€ 10.0.X.X/24~28 ê°€ëŠ¥
                    </div>
                </div>

                <div class="row g-3">
                    <div class="col-md-8">
                        <label class="fw-bold">ì„œë²„ ì´ë¦„</label>
                        <input type="text" id="server_name" name="server_name" class="form-control" value="web-svr-01" oninput="syncKeyName()">
                    </div>
                    <div class="col-md-4">
                        <label class="fw-bold">ë³¼ë¥¨ í¬ê¸° (GB)</label>
                        <input type="number" id="vol_size" name="volume_size" class="form-control" value="50">
                    </div>
                    <div class="col-md-6"><label class="fw-bold">ì´ë¯¸ì§€</label><select id="img_sel" name="image_id" class="form-select"></select></div>
                    <div class="col-md-6"><label class="fw-bold">Flavor</label><select id="fla_sel" name="flavor_id" class="form-select"></select></div>
                    <div class="col-12">
                        <label class="fw-bold text-success">í‚¤í˜ì–´ ì„¤ì •
                            <button type="button" class="btn btn-sm btn-outline-success ms-2" onclick="refreshKeypairs()" title="í‚¤í˜ì–´ ëª©ë¡ ìƒˆë¡œê³ ì¹¨">
                                ğŸ”„
                            </button>
                        </label>
                        <select id="key_sel" name="selected_key_name" class="form-select" onchange="toggleKeyInput()">
                            <option value="new">ğŸ†• ì‹ ê·œ í‚¤í˜ì–´ ìƒì„± (ì´ë¦„ ìë™ ë™ê¸°í™”)</option>
                        </select>
                        <div id="new_key_area" class="mt-2">
                            <input type="text" id="custom_key_name" name="custom_key_name" class="form-control" placeholder="í‚¤í˜ì–´ ì´ë¦„">
                        </div>
                    </div>
                </div>
            </div>
            <button type="button" class="btn btn-success w-100 py-3 fw-bold fs-4" onclick="runDeploy()">ì¸í”„ë¼ ë°°í¬ ì‹œì‘</button>
        </form>
    </div>

    <div id="final_res_area" class="final-display mt-4" style="display:none;"></div>
</div>

<script>
    /* [UI ë¡œì§] 4ë²ˆì§¸ ì˜¥íƒ¯ì„ ë§ˆìŠ¤í¬ì— ë§ê²Œ ë™ì  ìƒì„± (0, 128 ë“±) */
    function updateFourthOctetOptions() {
        const mask = parseInt(document.getElementById('mask_select').value);
        const fourthSel = document.getElementById('fourth_octet_select');
        fourthSel.innerHTML = '';

        const step = Math.pow(2, 32 - mask);
        // /24ì¼ ê²½ìš° stepì´ 256ì´ ë˜ë¯€ë¡œ í•œ ë²ˆë§Œ ì‹¤í–‰ë¨
        for (let i = 0; i < 256; i += step) {
            let opt = document.createElement('option');
            opt.value = i; opt.innerText = i;
            fourthSel.appendChild(opt);
        }
        calculateNetwork();
    }

    /* [ê¸°ëŠ¥] ì„œë²„ ì´ë¦„ ë³€ê²½ ì‹œ í‚¤í˜ì–´ ì´ë¦„ ìë™ ì œì•ˆ */
    function syncKeyName() {
        const sName = document.getElementById('server_name').value;
        if(document.getElementById('key_sel').value === 'new') {
            document.getElementById('custom_key_name').value = sName + "-key";
        }
    }

    function toggleKeyInput() {
        const isNew = document.getElementById('key_sel').value === 'new';
        document.getElementById('new_key_area').style.display = isNew ? 'block' : 'none';
        if(isNew) syncKeyName();
    }

    function updateUI() {
        const mode = document.querySelector('input[name="mode"]:checked').value;
        document.getElementById('vpc_input_area').style.display = (mode === 'm_new') ? 'block' : 'none';
        document.getElementById('vpc_select_area').style.display = (mode === 'm_new') ? 'none' : 'block';
        
        // ë³¼ë¥¨ í¬ê¸°ëŠ” í•­ìƒ ë³€ê²½ ê°€ëŠ¥ (ê¸°ì¡´ ì œì•½ ì œê±°)
        const vol = document.getElementById('vol_size');
        vol.readOnly = false; 
        vol.classList.remove('readonly-input');
        
        calculateNetwork();
    }

    /* [ë„¤íŠ¸ì›Œí¬] CIDR ì‹¤ì‹œê°„ ê³„ì‚° */
    function calculateNetwork() {
        const mode = document.querySelector('input[name="mode"]:checked').value;
        const third = document.getElementById('third_octet').value || 0;
        const fourth = document.getElementById('fourth_octet_select').value || 0;
        const mask = document.getElementById('mask_select').value;
        
        let baseIp = "10.0.0.0";
        let vpcCidr = "10.0.0.0/16";
        
        if(mode === 'm_new') {
            vpcCidr = document.getElementById('custom_vpc_cidr').value;
            baseIp = vpcCidr.split('/')[0];
        } else {
            const vSelect = document.getElementById('v_sel');
            if(vSelect.options.length > 0) {
                const text = vSelect.options[vSelect.selectedIndex].text;
                const match = text.match(/\((.*?)\)/);
                if(match) {
                    vpcCidr = match[1];
                    baseIp = vpcCidr.split('/')[0];
                }
            }
        }

        const seg = baseIp.split('.');
        const finalCidr = `${seg[0]}.${seg[1]}.${third}.${fourth}/${mask}`;
        
        // CIDR ê²€ì¦
        const isValid = validateSubnetCidr(finalCidr, vpcCidr);
        const displayElem = document.getElementById('display_cidr');
        const deployBtn = document.querySelector('button[onclick="runDeploy()"]');
        
        if(isValid) {
            displayElem.innerText = finalCidr;
            displayElem.style.color = '#0d6efd';
            deployBtn.disabled = false;
            deployBtn.classList.remove('btn-secondary');
            deployBtn.classList.add('btn-success');
        } else {
            displayElem.innerText = `${finalCidr} âš ï¸ VPC ë²”ìœ„ ë²—ì–´ë‚¨!`;
            displayElem.style.color = '#dc3545';
            deployBtn.disabled = true;
            deployBtn.classList.remove('btn-success');
            deployBtn.classList.add('btn-secondary');
        }
        
        document.getElementById('hidden_subnet_cidr').value = finalCidr;
        document.getElementById('hidden_vpc_cidr').value = vpcCidr;
    }
    
    /* [ê²€ì¦] Subnet CIDRì´ VPC CIDR ë²”ìœ„ ë‚´ì— ìˆëŠ”ì§€ í™•ì¸ */
    function validateSubnetCidr(subnetCidr, vpcCidr) {
        try {
            // CIDRì„ IPì™€ prefixë¡œ ë¶„ë¦¬
            const [subnetIp, subnetPrefix] = subnetCidr.split('/');
            const [vpcIp, vpcPrefix] = vpcCidr.split('/');
            
            const subnetPrefixNum = parseInt(subnetPrefix);
            const vpcPrefixNum = parseInt(vpcPrefix);
            
            // Subnet prefixëŠ” VPC prefixë³´ë‹¤ í¬ê±°ë‚˜ ê°™ì•„ì•¼ í•¨ (ë” ì‘ì€ ë²”ìœ„)
            if(subnetPrefixNum < vpcPrefixNum) return false;
            
            // IPë¥¼ 32bit ì •ìˆ˜ë¡œ ë³€í™˜
            const ipToInt = (ip) => {
                return ip.split('.').reduce((acc, octet) => (acc << 8) + parseInt(octet), 0) >>> 0;
            };
            
            const subnetInt = ipToInt(subnetIp);
            const vpcInt = ipToInt(vpcIp);
            
            // VPCì˜ ë„¤íŠ¸ì›Œí¬ ë§ˆìŠ¤í¬ ìƒì„±
            const vpcMask = (~0 << (32 - vpcPrefixNum)) >>> 0;
            
            // ë‘ IPì˜ ë„¤íŠ¸ì›Œí¬ ë¶€ë¶„ì´ ê°™ì€ì§€ í™•ì¸
            return (subnetInt & vpcMask) === (vpcInt & vpcMask);
        } catch(e) {
            return false;
        }
    }

    /* [API] ë¦¬ì†ŒìŠ¤ ì¡°íšŒ ë° ì´ˆê¸° ë¡œë”© */
    let currentAuthData = null; // ì¸ì¦ ì •ë³´ ì €ì¥
    
    async function getResources() {
        const overlay = document.getElementById('loading_overlay');
        overlay.style.display = 'flex';
        document.getElementById('loading_text').innerText = "ë¦¬ì†ŒìŠ¤ ì¡°íšŒ ì¤‘...";

        const authData = {
            region: document.getElementById('region').value,
            tenant_id: document.getElementById('tenant_id').value,
            user_id: document.getElementById('user_id').value,
            password: document.getElementById('password').value
        };
        
        currentAuthData = authData; // ì €ì¥

        try {
            const res = await fetch('/get_resources', { 
                method: 'POST', 
                headers: {'Content-Type': 'application/json'}, 
                body: JSON.stringify(authData) 
            });
            const data = await res.json();
            if(data.status === 'error') throw new Error(data.error);

            document.getElementById('v_sel').innerHTML = data.vpcs.map(v => `<option value="${v.id}">${v.name} (${v.cidrv4})</option>`).join('');
            document.getElementById('img_sel').innerHTML = data.images.map(i => `<option value="${i.id}">${i.name}</option>`).join('');
            document.getElementById('fla_sel').innerHTML = data.flavors.map(f => `<option value="${f.id}">${f.name} (vCPU:${f.vcpus}/RAM:${f.ram})</option>`).join('');
            document.getElementById('key_sel').innerHTML = '<option value="new">ğŸ†• ì‹ ê·œ í‚¤í˜ì–´ ìƒì„±</option>' + 
                data.keypairs.map(k => `<option value="${k.keypair.name}">${k.keypair.name}</option>`).join('');
            
            document.getElementById('hidden_pub_id').value = data.pub_id;
            document.getElementById('deploy-section').style.display = 'block';
            
            updateFourthOctetOptions();
            updateUI(); 
            toggleKeyInput();
        } catch(e) { 
            alert("ë™ê¸°í™” ì—ëŸ¬: " + e.message); 
        } finally { 
            overlay.style.display = 'none'; 
        }
    }
    
    /* [ê°œë³„ ìƒˆë¡œê³ ì¹¨] VPC ëª©ë¡ë§Œ ìƒˆë¡œê³ ì¹¨ */
    async function refreshVpcs() {
        if(!currentAuthData) {
            alert("ë¨¼ì € 'ìì› ë™ê¸°í™”'ë¥¼ ì‹¤í–‰í•´ì£¼ì„¸ìš”.");
            return;
        }
        
        try {
            const res = await fetch('/get_resources', { 
                method: 'POST', 
                headers: {'Content-Type': 'application/json'}, 
                body: JSON.stringify(currentAuthData) 
            });
            const data = await res.json();
            if(data.status === 'error') throw new Error(data.error);
            
            document.getElementById('v_sel').innerHTML = data.vpcs.map(v => `<option value="${v.id}">${v.name} (${v.cidrv4})</option>`).join('');
            calculateNetwork();
            alert("âœ… VPC ëª©ë¡ ì—…ë°ì´íŠ¸ ì™„ë£Œ");
        } catch(e) {
            alert("VPC ìƒˆë¡œê³ ì¹¨ ì‹¤íŒ¨: " + e.message);
        }
    }
    
    /* [ê°œë³„ ìƒˆë¡œê³ ì¹¨] í‚¤í˜ì–´ ëª©ë¡ë§Œ ìƒˆë¡œê³ ì¹¨ */
    async function refreshKeypairs() {
        if(!currentAuthData) {
            alert("ë¨¼ì € 'ìì› ë™ê¸°í™”'ë¥¼ ì‹¤í–‰í•´ì£¼ì„¸ìš”.");
            return;
        }
        
        try {
            const res = await fetch('/get_resources', { 
                method: 'POST', 
                headers: {'Content-Type': 'application/json'}, 
                body: JSON.stringify(currentAuthData) 
            });
            const data = await res.json();
            if(data.status === 'error') throw new Error(data.error);
            
            document.getElementById('key_sel').innerHTML = '<option value="new">ğŸ†• ì‹ ê·œ í‚¤í˜ì–´ ìƒì„±</option>' + 
                data.keypairs.map(k => `<option value="${k.keypair.name}">${k.keypair.name}</option>`).join('');
            toggleKeyInput();
            alert("âœ… í‚¤í˜ì–´ ëª©ë¡ ì—…ë°ì´íŠ¸ ì™„ë£Œ");
        } catch(e) {
            alert("í‚¤í˜ì–´ ìƒˆë¡œê³ ì¹¨ ì‹¤íŒ¨: " + e.message);
        }
    }
    
    /* [VPC ì¤‘ë³µ ì²˜ë¦¬] ì‚¬ìš©ì ì„ íƒ ì²˜ë¦¬ */
    let vpcDuplicateResolver = null;
    
    function handleVpcDuplicate(action) {
        const modal = document.getElementById('vpc_duplicate_modal');
        modal.style.display = 'none';
        
        if(action === 'cancel') {
            if(vpcDuplicateResolver) {
                vpcDuplicateResolver.reject("ì‚¬ìš©ì ì·¨ì†Œ");
            }
            document.getElementById('loading_overlay').style.display = 'none';
        } else {
            if(vpcDuplicateResolver) {
                vpcDuplicateResolver.resolve(action);
            }
        }
    }

    /* [API] ë°°í¬ ì‹¤í–‰ ë° ë¡œê·¸ ì¶œë ¥ */
    async function runDeploy() {
        const overlay = document.getElementById('loading_overlay');
        const logBox = document.getElementById('log_viewer');
        overlay.style.display = 'flex'; 
        logBox.innerHTML = "";

        const fd = new FormData(document.getElementById('deploy-form'));
        ['region','tenant_id','user_id','password'].forEach(k => {
            const val = document.getElementById(k).value;
            if(!val) return alert(k + " ê°’ì´ ëˆ„ë½ë˜ì—ˆìŠµë‹ˆë‹¤.");
            fd.append(k, val);
        });

        try {
            const response = await fetch('/deploy', { method: 'POST', body: fd });
            const reader = response.body.getReader();
            const decoder = new TextDecoder();

            while(true) {
                const { value, done } = await reader.read();
                if(done) break;
                const chunk = decoder.decode(value);
                const lines = chunk.split('\n');
                
                for(const line of lines) {
                    if(!line.startsWith('data: ')) continue;
                    let data;
                    try {
                        data = JSON.parse(line.substring(6));
                    } catch(e) { continue; }

                    if(data.type === 'progress') {
                        document.getElementById('loading_text').innerText = data.msg;
                        logBox.innerHTML += `<div style="color: #00ff00;">> ${data.msg}</div>`;
                        logBox.scrollTop = logBox.scrollHeight;
                    } 
                    else if(data.type === 'result') {
                        overlay.style.display = 'none';
                        renderFinal(data.payload);
                        return;
                    } 
                    else if(data.type === 'vpc_duplicate') {
                        // VPC ì¤‘ë³µ ê°ì§€ - ì‚¬ìš©ìì—ê²Œ ì„ íƒ ìš”ì²­
                        document.getElementById('duplicate_vpc_name').innerText = data.payload.vpc_name;
                        const modal = document.getElementById('vpc_duplicate_modal');
                        modal.style.display = 'flex';
                        
                        // Promiseë¡œ ì‚¬ìš©ì ì„ íƒ ëŒ€ê¸°
                        const userChoice = await new Promise((resolve, reject) => {
                            vpcDuplicateResolver = { resolve, reject };
                        });
                        
                        // ì‚¬ìš©ì ì„ íƒì„ FormDataì— ì¶”ê°€í•˜ê³  ì¬ì‹œë„
                        fd.append('vpc_duplicate_action', userChoice);
                        
                        // ì¬ê·€ í˜¸ì¶œ ëŒ€ì‹  ìƒˆë¡œìš´ ìš”ì²­
                        logBox.innerHTML += `<div style="color: #ffaa00;">> ì‚¬ìš©ì ì„ íƒ: ${userChoice === 'use_existing' ? 'ê¸°ì¡´ VPC ì‚¬ìš©' : 'ìƒˆ ì´ë¦„ìœ¼ë¡œ ìƒì„±'}</div>`;
                        
                        const retryResponse = await fetch('/deploy', { method: 'POST', body: fd });
                        const retryReader = retryResponse.body.getReader();
                        
                        // ì¬ì‹œë„ ìŠ¤íŠ¸ë¦¼ ì²˜ë¦¬ (ì¤‘ë³µ ì½”ë“œ ë°©ì§€ë¥¼ ìœ„í•´ ë™ì¼ ë¡œì§)
                        while(true) {
                            const { value: retryValue, done: retryDone } = await retryReader.read();
                            if(retryDone) break;
                            const retryChunk = decoder.decode(retryValue);
                            const retryLines = retryChunk.split('\n');
                            
                            for(const retryLine of retryLines) {
                                if(!retryLine.startsWith('data: ')) continue;
                                let retryData;
                                try {
                                    retryData = JSON.parse(retryLine.substring(6));
                                } catch(e) { continue; }
                                
                                if(retryData.type === 'progress') {
                                    document.getElementById('loading_text').innerText = retryData.msg;
                                    logBox.innerHTML += `<div style="color: #00ff00;">> ${retryData.msg}</div>`;
                                    logBox.scrollTop = logBox.scrollHeight;
                                } 
                                else if(retryData.type === 'result') {
                                    overlay.style.display = 'none';
                                    renderFinal(retryData.payload);
                                    return;
                                } 
                                else if(retryData.type === 'error') {
                                    logBox.innerHTML += `<div style="color: #ff4444; font-weight: bold;">! ìµœì¢… ì—ëŸ¬: ${retryData.msg}</div>`;
                                    setTimeout(() => {
                                        overlay.style.display = 'none';
                                        alert("ë°°í¬ ì¤‘ë‹¨: " + retryData.msg);
                                    }, 2000);
                                    return;
                                }
                            }
                        }
                        return;
                    } 
                    else if(data.type === 'error') {
                        logBox.innerHTML += `<div style="color: #ff4444; font-weight: bold;">! ìµœì¢… ì—ëŸ¬: ${data.msg}</div>`;
                        setTimeout(() => {
                            overlay.style.display = 'none';
                            alert("ë°°í¬ ì¤‘ë‹¨: " + data.msg);
                        }, 2000);
                        return;
                    }
                }
            }
        } catch(e) { 
            overlay.style.display = 'none'; 
            alert("ì„œë²„ ì—°ê²°ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤."); 
        }
    }

    function renderFinal(res) {
        const area = document.getElementById('final_res_area');
        area.style.display = 'block';
        area.innerHTML = `
            <h3>ğŸš€ ì¸í”„ë¼ êµ¬ì¶• ì„±ê³µ</h3>
            <p class="fs-4">Public IP: <b>${res.floating_ip}</b></p>
            ${res.private_key ? `<button id="download_btn" class="btn btn-warning fw-bold">í‚¤í˜ì–´(.pem) ì €ì¥</button>` : ''}
        `;
        if(res.private_key) {
            document.getElementById('download_btn').onclick = () => {
                const blob = new Blob([res.private_key], { type: 'text/plain' });
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url; a.download = `${res.key_name}.pem`; a.click();
            };
        }
    }
</script>
</body>
</html>